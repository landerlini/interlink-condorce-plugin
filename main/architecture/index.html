<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://landerlini.baltig-pages.infn.it/interlink-condorce-plugin/architecture/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Architecture - InterLink NATS Plugin</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Architecture";
        var mkdocs_page_input_path = "architecture.md";
        var mkdocs_page_url = "/interlink-condorce-plugin/architecture/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> InterLink NATS Plugin
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">InterLink NATS Plugin</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Architecture</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#the-lifecycle-of-a-job">The lifecycle of a job</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#build-configuration-and-allocatable-resources">Build Configuration and Allocatable Resources</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deploy/">Deployment with Helm</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Concepts</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/nats/">NATS messaging layer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/kueue-nats/">Kueue integration (MasterQueue)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/build-config/">Build Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/pilot/">Pilot Container</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../concepts/git-sync/">Git Sync</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Providers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../providers/condor/">Condor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../providers/podman/">Podman</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../providers/slurm/">Slurm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../providers/kubernetes/">Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Branches</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/main/">main</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/landerlini/">L. Anderlini</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">InterLink NATS Plugin</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Architecture</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="architecture">Architecture</h1>
<p>As you may probably guess, the InterLink NATS Plugin is a <em>plugin</em> for 
<a href="https://intertwin-eu.github.io/interLink/">InterLink</a>, 
a <a href="https://virtual-kubelet.io/">Virtual Kubelet</a> provider designed to execute 
Kubernetes pods in batch-job providers.</p>
<p>The InterLink NATS Plugin is built on two core ideas:</p>
<ul>
<li>a NATS overlay, accessed via TLS-terminated WebSockets, enable a bidirectional communication between the login- 
   or edge-nodes of the resource providers without the need for network ingress rules. </li>
<li>the job is converted into a bash script with the same Python code for all execution backends; the job script is 
   sent by the plugin via NATS and submitted by a thin script to one of the queues; this approach reduces the 
   duplication of the logics translating a Kubernetes pod in a bash script (which comes with a price in terms of 
   supported features).</li>
</ul>
<p>To manage the submission of payloads to multiple sites, possibly with different prices, features and limitations,
the InterLink NATS plugin relies on Kueue. A simple operator, named <code>kueue-nats</code>, takes care of mapping the resource
providers into Kueue <a href="https://kueue.sigs.k8s.io/docs/concepts/resource_flavor/">ResourceFlavors</a> and 
<a href="https://kueue.sigs.k8s.io/docs/concepts/cluster_queue/">ClusterQueues</a> following the directives defined in a 
custom resource named <code>MasterQueue</code> and the available resource as published via NATS from the submitters. </p>
<p>For details on the definition of a <code>MasterQueue</code> and on the <code>kueue-nats</code> controller, check the dedicated 
<a href="../concepts/kueue-nats/">documentation</a>.</p>
<p>A schematic representation of the architecture is presented below.</p>
<p><img alt="architecture.png" src="../images/interlink-nats-plugin.png" /></p>
<h2 id="the-lifecycle-of-a-job">The lifecycle of a job</h2>
<p>To ease understanding the steps entering the submission and the execution of a Job, let's consider an example 
job and let's discuss the steps of its admission and submission.</p>
<ol>
<li><strong>Job creation.</strong> A <code>batch/V1Job</code> resource is created by some <em>Workload manager</em> or by <code>kubectl</code>. 
   It should include the Kueue-specific annotations defining the target <code>LocalQueue</code> and, if intended for
   offloading, it must feature the standard InterLink toleration for the taint 
   <code>virtual-node.interlink/no-schedule=true:NoSchedule</code>.</li>
<li><strong>Job admission.</strong> When the <code>ClusterQueue</code> the job has been submitted to has sufficient resources it admits the 
   workload, assigning the highest-priority, compatible <code>ResourceFlavor</code>. 
   Kueue defines the resource pool to which the payload is destined with the toleration <code>pool.vk.io</code>. It will be 
   responsibility of the plugin to submit the payload with the correct NATS subject to make the submitters of the 
   right pool to receive and process it.
   Note that a <code>ClusterQueue</code> can include both
   local and interlink-related flavors, so a job tolerating offloading can be executed locally if the remote providers
   are either not available or completely committed or their corresponding <code>ResourceFlavors</code> are defined in the 
   ClusterQueue logic at lower priority. Clearly, jobs not tolerating offloading will be mapped on local
   <code>ResourceFlavors</code> only.</li>
<li><strong>Job transmission.</strong> Once the Job is assigned to a <em>VirtualKubelet</em>, it is propagated to the InterLink API server
   and then to the InterLink NATS Plugin. In Helm chart made available in this repository, the three components are run
   in three containers of the same pod and communicate through a loopback network interface. Other architectures 
   splitting the containers in different Pods, or even cluster, with OAuth2-proxy for authentication have been tested 
   successfully, but they are too complex for being centrally maintained.</li>
<li><strong>Job translation.</strong> Once the job reaches the plugin, it gets translated into a bash script. Note that the target 
   pool is known at conversion time, and the generation of the script can be tweaked via a <code>BuildConfig</code> that the 
   submitter publish periodically via NATS. This enables defining custom caches or singularity flags.</li>
<li><strong>Job request.</strong> The Job is sent to the submitter through a NATS request, using a subject including the pod name.</li>
<li><strong>Job submission.</strong> Finally, the job received by the <em>backend-specific submitter</em> which submits it to the actual
   backend.</li>
</ol>
<h2 id="build-configuration-and-allocatable-resources">Build Configuration and Allocatable Resources</h2>
<p>To inform the InterLink API Plugin of the requested configuration to generate the bash script running the job and 
to inform the <code>kueue-nats</code> controller of the resources available in the node, NATS is used. 
When launched, and then at periodic intervals, the submitters publish the <code>BuildConfig</code> object and the locally 
available resources.
The <code>BuildConfig</code> for each pod is optionally cached in a redis database to avoid disruption of the service in case 
of restart of the plugin api-server.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="InterLink NATS Plugin"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../deploy/" class="btn btn-neutral float-right" title="Deployment with Helm">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../deploy/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
