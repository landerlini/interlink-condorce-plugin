<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://landerlini.baltig-pages.infn.it/interlink-condorce-plugin/concepts/kueue-nats/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Kueue integration (MasterQueue) - InterLink NATS Plugin</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Kueue integration (MasterQueue)";
        var mkdocs_page_input_path = "concepts/kueue-nats.md";
        var mkdocs_page_url = "/interlink-condorce-plugin/concepts/kueue-nats/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> InterLink NATS Plugin
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">InterLink NATS Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../deploy/">Deployment with Helm</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Concepts</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../nats/">NATS messaging layer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Kueue integration (MasterQueue)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#organizing-flavors">Organizing Flavors</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#natsflavors">natsFlavors</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#minimal-masterqueue-definition">Minimal MasterQueue definition</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#creating-a-localqueue">Creating a LocalQueue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#a-test-job">A test job</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#local-flavors">Local flavors</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../build-config/">Build Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pilot/">Pilot Container</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../git-sync/">Git Sync</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Providers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../providers/condor/">Condor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../providers/podman/">Podman</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../providers/slurm/">Slurm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../providers/kubernetes/">Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Branches</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/main/">main</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/landerlini/">L. Anderlini</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">InterLink NATS Plugin</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Concepts</li>
      <li class="breadcrumb-item active">Kueue integration (MasterQueue)</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="kueue-integration-masterqueue">Kueue integration (<code>MasterQueue</code>)</h1>
<p>The bidirectional <a href="../nats/">messaging layer provided by NATS</a> enables feedbacks on the status of the 
resource pools on the resources they may provide. To enable the definition of policies on the resource usage defined 
at cluster level (rather than at node level) the InterLink resource pools are mapped into kueue 
<a href="https://kueue.sigs.k8s.io/docs/concepts/resource_flavor/"><code>ResourceFlavor</code>s</a> and organized in 
<a href="https://kueue.sigs.k8s.io/docs/concepts/cluster_queue/"><code>ClusterQueue</code>s</a>.</p>
<p>A custom controller, named <code>kueue-nats</code>, connects to the NATS server and subscribe to the subjects under which 
resource providers publish the available resources. When receiving resource updates, the <code>kueue-nats</code> controller 
creates or updates <code>ResourceFlavor</code>s the <code>ClusterQueue</code>s accordingly. The configuration of the <code>kueue-nats</code> controller 
relies on a Kubernetes Custom Resource (CR) named <code>MasterQueue</code>.</p>
<p>A <code>MasterQueue</code> is supposed to be the cluster-level object collecting all the resource pools made available to the 
cluster either via InterLink or as local resources. The MasterQueue can then lend resources to groups of users or 
client applications using the <a href="https://kueue.sigs.k8s.io/docs/concepts/cluster_queue/#cohort">Kueue resource-borrowing mechanism</a>. 
All the <code>ClusterQueue</code>s spawned by a <code>MasterQueue</code> belong to the same <em>cohort</em>, named by the <code>MasterQueue</code> itself.</p>
<h2 id="organizing-flavors">Organizing Flavors</h2>
<p>As mentioned, <code>ResourceFlavor</code>s map resource pools. Since multiple resource pools might be equivalent and 
interchangeable to the applications running in the cluster (think for example of two Kubernetes clusters running 
in different sites), <code>kueue-nats</code> introduces <em>groups</em> of <code>ResourceFlavor</code>s, mapping groups of equivalent resource
pools. </p>
<p>Groups of resource flavors may fall in two categories: <code>natsFlavor</code>, managed by InterLink via the InterLink NATS plugin,
or <code>localFlavor</code>, managed by the cluster administrator directly via Kueue and made available to the MasterQueue.</p>
<h3 id="natsflavors"><code>natsFlavor</code>s</h3>
<p>A <code>natsFlavor</code> should indicate the following properties:
 * <code>natsConnector</code>: a string defining the connection to the NATS server. If deploying the NATS plugin with the 
   <a href="../../deploy/"><em>interlink-in-one</em></a>, this string is provided by Helm itself when installing or updating the chart.
 * <code>natsSubject</code>: a string representing the NATS subject used by resource pools to publish updates on the available 
   resources
 * <code>virtualNode</code>: is the name of the virtual node where to address pods to be submitted with interlink
 * <code>poolTimeout</code>: an integer defining the timeout in seconds. If no update to the available resources is obtained 
   after this time interval, the corresponding resource flavor is dropped.</p>
<p>The names of pools part of the group can be listed explicitly using the <code>pools</code> keyword,</p>
<pre><code class="language-yaml">pools:
  - podman-firenze
  - slurm-cineca
</code></pre>
<p>or it can be defined with a regular expression using the <code>poolRegExp</code>, for example</p>
<pre><code class="language-yaml">poolRegExp: &quot;podman-.*&quot;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the regular expression is managed with the <code>re</code> module in Python. </p>
</div>
<h2 id="minimal-masterqueue-definition">Minimal <code>MasterQueue</code> definition</h2>
<p>A minimal example of a MasterQueue is defined below with annotations</p>
<pre><code class="language-yaml">apiVersion: vk.io/v1
kind: MasterQueue
metadata:
  name: masterqueue  # This is the name of the MasterQueue 
spec:
  template:
    cohort: masterqueue  # This is the name of the cohort. It is suggested to use the same name as for the MasterQueue.

  flavors:   # Here we introduce the list of resource flavors organized in categories. RFs can be either `natsFlavor`s or `localFlavor`s.
    - name: interlink  # This is the name of the flavor category (not of the flavor itself!)
      natsFlavor:
        natsConnector: &quot;nats://user:password@nats.nats:4222&quot;
        natsSubject: interlink.resources
        virtualNode: interlink
        poolTimeout: 30
        poolRegExp: &quot;.*&quot;
      nominalQuota:
        pods: 100
      canLendTo:
        - queue: group1
          lendingLimit:
            pods: 30
</code></pre>
<p>This creates two <code>ClusterQueue</code> objects belonging to the same cohort <code>masterqueue</code>. One named <code>masterqueue</code> 
(as the <code>MasterQueue</code> object) has quotas based on the resources published by the various providers, the other, 
named <code>group1</code> has no quota, but a <code>borrowingLimit</code> for pods set to 30.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The limits are specified <em>per resource pool</em>. In the example above, if two resource pools are available, the 
ClusterQueue <code>group1</code> will be entitled to borrow 30 pods from the first one and 30 pods from the second. </p>
</div>
<h2 id="creating-a-localqueue">Creating a <code>LocalQueue</code></h2>
<p>To connect a namespace to a <code>ClusterQueue</code>, the cluster admins must create <code>LocalQueue</code> objects. For example, to 
enable executing jobs in the <code>default</code> namespace in the <code>group1</code> ClusterQueue, one may define the <code>gr1</code> LocalQueue as</p>
<pre><code class="language-yaml">apiVersion: kueue.x-k8s.io/v1beta1
kind: LocalQueue
metadata:
   namespace: default
   name: gr1
spec:
   clusterQueue: group1
</code></pre>
<h2 id="a-test-job">A test job</h2>
<p>To test the setup, one may submit a test job in the <code>default</code> namespace through the queue <code>gr1</code>.</p>
<pre><code class="language-yaml">apiVersion: batch/v1
kind: Job
metadata:
  generateName: sample-job-1
  namespace: default
  labels:
    kueue.x-k8s.io/queue-name: gr1
spec:
  parallelism: 1
  completions: 1
  suspend: true
  template:
    spec:
      containers:
      - name: dummy-job
        image:  ghcr.io/grycap/cowsay:latest
        command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
        args: 
         - |
                echo &quot;Hello world!&quot;
                sleep 30

        resources:
          requests:
            cpu: 1
            memory: &quot;200Mi&quot;
      tolerations:
        - key: virtual-node.interlink/no-schedule
          operator: Exists
          effect: NoSchedule
      restartPolicy: Never
</code></pre>
<p>Note in particular:
 * the label <code>kueue.x-k8s.io/queue-name: gr1</code> defining the local queue,
 * the spec <code>suspend: true</code> to let Kueue to submit the job once admitted, 
 * the toleration to the node taint <code>virtual-node.interlink/no-schedule</code> marking the job as suitable for offloading.</p>
<h2 id="local-flavors">Local flavors</h2>
<p>To enable local execution of payloads not suitable for offloading, one may include a local flavor in the <code>MasterQueue</code>.
Local flavors are a simply links to the standard <code>ResourceFlavor</code> objects of the Kueue that must be already defined in 
the cluster and fall outside the range of action of the <code>kueue-nats</code> controller.</p>
<p>For example the following <code>yaml</code> manifest defines a <code>ResourceFlavor</code> and makes it available to the <code>group1</code>
<code>ClusterQueue</code> via the <code>MasterQueue</code>. </p>
<pre><code class="language-yaml">apiVersion: kueue.x-k8s.io/v1beta1
kind: ResourceFlavor
metadata:
  name: &quot;local-cpu&quot;  # &lt;-- Note this name

---

apiVersion: vk.io/v1
kind: MasterQueue
metadata:
   name: masterqueue  
spec:
   template:
      cohort: masterqueue  

   flavors:   
      - name: local-cpu   # &lt;-- This name should match the ResourceFlavor definition above
        localFlavor: {}
        nominalQuota:
           pods: 100
        canLendTo:
           - queue: group1
             lendingLimit:
                pods: 30
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../authentication/" class="btn btn-neutral float-left" title="Authentication"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../build-config/" class="btn btn-neutral float-right" title="Build Configuration">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../authentication/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../build-config/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
