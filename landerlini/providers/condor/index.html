<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://landerlini.baltig-pages.infn.it/interlink-condorce-plugin/providers/condor/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Condor - InterLink NATS Plugin</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Condor";
        var mkdocs_page_input_path = "providers/condor.md";
        var mkdocs_page_url = "/interlink-condorce-plugin/providers/condor/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> InterLink NATS Plugin
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">InterLink NATS Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../deploy/">Deployment with Helm</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Concepts</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/nats/">NATS messaging layer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/authentication/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/kueue-nats/">Kueue integration (MasterQueue)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/build-config/">Build Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/pilot/">Pilot Container</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../concepts/git-sync/">Git Sync</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Providers</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Condor</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#kubernetes">Kubernetes</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../podman/">Podman</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../slurm/">Slurm</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../kubernetes/">Kubernetes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Branches</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/main/">main</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://landerlini.github.io/interlink-condorce-plugin/landerlini/">L. Anderlini</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">InterLink NATS Plugin</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Providers</li>
      <li class="breadcrumb-item active">Condor</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="condor-provider">Condor provider</h1>
<p>Condor jobs are submitted through a Condor Compute Entrypoint authenticated through Javascript Web Tokens (JWT) 
provided by an Indigo IAM Instance. </p>
<p>We report below recipes to configure the condor provider.</p>
<h2 id="kubernetes">Kubernetes</h2>
<p>The reported configuration works for INFN-T1 site. Modifications might be needed (especially for paths) in other 
sites. Then at some point we will have cvmfs.</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: condor-sub-build-conf
data:
  interlink.conf: |
    # Volumes and directories configuring access to executor-local data
    [volumes]

    ### Area in the executor filesystem to be used for temporary files
    scratch_area = &quot;/tmp&quot;

    ### Location to cache singularity images in the executor filesystem
    apptainer_cachedir = &quot;/tmp/cache/apptainer&quot;

    ### Location where to look for pre-built images
    image_dir = &quot;/opt/exp_software/opssw/budda&quot;

    ### Colon-separated list of directories to include in $PATH to look for executables
    additional_directories_in_path = [&quot;/opt/exp_software/opssw/mabarbet/bin&quot;]



    # Options configuring the behavior of apptainer runtime
    [apptainer]

    ### Enables --fakeroot in apptainer exec/run commands
    fakeroot = false

    ### Enables --containall flag in apptainer exec/run commands
    containall = false

    ### Defines whether the host enables users to mount fuse volumes or not
    fuse_mode = &quot;host-privileged&quot;

    ### Do not propagate umask to the container, set default 0022 umask
    no_init = false

    ### Do not bind home by default
    no_home = true

    ### Drop all privileges from root user in container
    no_privs = true

    ### Enable nVidia GPU support
    nvidia_support = false

    ### Clean the environment of the spawned container
    cleanenv = true



    # Proxy to download pre-build Docker Images instead of rebuilding at each execution
    [shub_proxy]

    ### shub proxy instance used to retrieve cached singularity images. Without protocol!
    server = &quot;&lt;insert shub-proxy endpoint&gt;&quot;

    ### Master token of the proxy used to request and generate client tokens
    master_token = &quot;&lt;insert shub-proxy master token&gt;&quot;


  interlink.sh: |
    echo &quot;Cloning the repo&quot;
    git clone --quiet --branch main https://github.com/landerlini/interlink-condorce-plugin plugin &amp;&gt; log
    echo &quot;Repo cloned&quot;
    cd plugin

    mkdir -p /opt/interlink
    echo &quot;Starting authentication procedure&quot;
    python3 -u natsprovider/tests/_auth.py /opt/interlink/refresh_token
    export REFRESH_TOKEN=$(cat /opt/interlink/refresh_token)

    while true
    do
      git pull &amp;&gt;&gt; log

      python3 -um natsprovider condor \
          --queue &quot;infncnaf&quot; \
          --shutdown-subject &quot;*&quot; \
          --non-interactive

    done


---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: condor-submitter
  labels:
    app: interlink
    component: condor-submitter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: interlink
      component: condor-submitter
  template:
    metadata:
      labels:
        app: interlink
        component: condor-submitter
    spec:
      securityContext:
        fsGroup: 101

      containers:
        - name: condorprovider
          image: &quot;landerlini/interlink-condorce-plugin:v0.1.2&quot;
          command: [&quot;/bin/bash&quot;, &quot;-u&quot;, &quot;/etc/interlink/interlink.sh&quot;]

          env:
            - name: DEBUG
              value: &quot;true&quot;
            - name: TOKEN_VALIDITY_SECONDS
              value: &quot;1200&quot;
            - name: _condor_CONDOR_HOST
              value: &quot;ce01t-htc.cr.cnaf.infn.it:9619&quot;
            - name: CONDOR_POOL
              value: &quot;ce01t-htc.cr.cnaf.infn.it:9619&quot;
            - name: _condor_SCHEDD_HOST
              value: &quot;ce01t-htc.cr.cnaf.infn.it&quot;
            - name: CONDOR_SCHEDULER_NAME
              value: &quot;ce01t-htc.cr.cnaf.infn.it&quot;
            - name: IAM_ISSUER
              value: &quot;https://iam-t1-computing.cloud.cnaf.infn.it&quot;
            - name: IAM_CLIENT_ID
              value: &lt;iam client id&gt;
            - name: IAM_CLIENT_SECRET
              value: &lt;iam client secret&gt;
            - name: NATS_SUBJECT
              value: &quot;interlink&quot;
            - name: NATS_SERVER
              value: &lt;nats server connector&gt;
            - name: NATS_TIMEOUT_SECONDS
              value: &quot;60&quot;
            - name: DEFAULT_ALLOCATABLE_CPU
              value: &quot;1&quot;
            - name: DEFAULT_ALLOCATABLE_MEMORY
              value: &quot;2Gi&quot;
            - name: DEFAULT_ALLOCATABLE_PODS
              value: &quot;10&quot;
            - name: DEFAULT_ALLOCATABLE_GPUS
              value: &quot;0&quot;

          volumeMounts:
            - name: condorplugin-conf
              mountPath: /etc/interlink
              readOnly: true


      volumes:
        - name: condorplugin-conf
          configMap:
            name: condor-sub-build-conf
            items:
              - key: interlink.conf
                path: build.conf
              - key: interlink.sh
                path: interlink.sh
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../concepts/git-sync/" class="btn btn-neutral float-left" title="Git Sync"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../podman/" class="btn btn-neutral float-right" title="Podman">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../concepts/git-sync/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../podman/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
